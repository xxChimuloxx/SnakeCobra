<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cobra Snake</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111823;
      --ink:#e8f1ff;
      --accent:#22c55e;
      --danger:#ef4444;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{
      margin:0;min-height:100svh;display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      background: radial-gradient(1200px 800px at 20% -10%, #18202c 0%, var(--bg) 60%), var(--bg);
      color:var(--ink);font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial;
      letter-spacing:.2px;
    }
    .app{display:grid;gap:16px;grid-template-columns:1fr;max-width:980px;padding:20px}
    .board{display:grid;grid-template-columns:1fr auto;gap:18px}
    .card{
      background:linear-gradient(180deg, #0e1522 0%, #0b111b 100%);
      border:1px solid #1c2736;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);
      padding:16px
    }
    h1{font-size:24px;margin:0 0 6px;display:flex;align-items:center;gap:8px}
    h1 .cobra{font-size:28px}
    .sub{color:var(--muted);font-size:12px;margin-bottom:6px}
    canvas{
      width:560px;max-width:92vw;aspect-ratio:1/1;image-rendering: pixelated;
      border-radius:12px;border:1px solid #213146;background:#0a0f17
    }
    .gamewrap{position:relative;display:inline-block}
    .overlay{
      position:absolute;inset:0;display:grid;place-items:center;
      background:rgba(10,15,23,.72);backdrop-filter: blur(3px)
    }
    .overlay.hidden{display:none}
    .ov-card{
      background:#0e1522;border:1px solid #1c2736;border-radius:14px;
      box-shadow:0 12px 40px rgba(0,0,0,.45);padding:18px;
      max-width:min(92vw,420px);text-align:center
    }
    .ov-card h2{margin:6px 0 8px;font-size:22px}
    .ov-card p{margin:0 0 12px;color:#9fb2cc}
    .ov-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .ov-actions .secondary{background:#0e1622;color:var(--ink);border:1px solid #223145;box-shadow:none}
    .hidden{display:none !important}
    .panel{width:260px;max-width:92vw;display:grid;gap:12px;align-content:start}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kpi .metric{padding:10px 12px;background:#0d1520;border:1px solid #1b2533;border-radius:10px}
    .metric .label{font-size:11px;color:var(--muted)}
    .metric .val{font-size:20px;margin-top:4px}
    .controls{
      display:flex;
      flex-direction:column; /* uno abajo del otro */
      gap:8px;
      width:100%;
    }
    .controls button{
      width:100%;      /* que cada bot√≥n ocupe todo el ancho del panel */
      text-align:center;
    }
    button{
      cursor:pointer;border:none;border-radius:10px;padding:10px 14px;font-weight:600;color:#0a0f17;
      background:var(--accent);box-shadow:0 6px 16px rgba(34,197,94,.25)
    }
    button.secondary{background:#0e1622;color:var(--ink);border:1px solid #223145;box-shadow:none}
    button.danger{background:var(--danger);color:#fff}
    .dpad{
      display:grid;grid-template-columns:repeat(3,48px);grid-template-rows:repeat(3,48px);
      place-items:center;gap:6px;margin:12px auto 6px;user-select:none
    }
    .dpad button{
      width:48px;height:48px;border-radius:10px;background:#0f1724;
      color:var(--ink);border:1px solid #223145;font-size:18px
    }
    .dpad .ghost{opacity:0}
    .footer-page{
      font-size:12px;color:var(--muted);text-align:center;margin:6px 0 12px;
    }
    .progress-row{
      display:flex;align-items:center;gap:10px;
      font-size:12px;color:var(--muted);margin-bottom:8px
    }
    .progress-label strong{color:var(--ink)}
    .progress-bar{
      flex:1;height:8px;border-radius:999px;
      background:#111827;border:1px solid #1f2933;overflow:hidden
    }
    .progress-fill{
      height:100%;width:0%;border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#a3e635)
    }
    @media (max-width:900px){.board{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1><span class="cobra">üêç</span> Cobra Snake</h1>
      <div class="sub">
        Instrucciones de movimiento. (en PC) Flechas o WASD (En m√≥vil) Toques en el D-Pad.<br>
        Objetivo. Captura las frutas para conocer m√°s de las cobras.
      </div>

      <!-- Barra de progreso de frutas -->
      <div class="progress-row">
        <div class="progress-label">
          Frutas: <strong><span id="fruitCount">0</span>/<span id="fruitGoal">140</span></strong>
        </div>
        <div class="progress-bar">
          <div id="fruitFill" class="progress-fill"></div>
        </div>
      </div>

      <div class="board">
        <div class="gamewrap">
          <canvas id="game" width="560" height="560" aria-label="tablero del juego" role="img"></canvas>
          <div id="overlay" class="overlay hidden">
            <div class="ov-card">
              <h2 id="ov-title">‚Äî</h2>
              <p id="ov-text">‚Äî</p>
              <div class="ov-actions">
                <button id="ov-primary">Continuar</button>
                <button id="ov-secondary" class="secondary hidden">Reiniciar</button>
              </div>
            </div>
          </div>
        </div>
        <div class="panel card">

          <div class="dpad" aria-hidden="false">
            <span class="ghost"></span>
            <button data-dir="up">‚Üë</button>
            <span class="ghost"></span>
            <button data-dir="left">‚Üê</button>
            <button data-dir="down">‚Üì</button>
            <button data-dir="right">‚Üí</button>
          </div>

          <div class="kpi">
            <div class="metric"><div class="label">Puntuaci√≥n</div><div id="score" class="val">0</div></div>
            <div class="metric"><div class="label">R√©cord</div><div id="best" class="val">0</div></div>
          </div>
          <div class="controls">
            <button id="startBtn">Iniciar</button>
            <button id="pauseBtn" class="secondary">Pausa</button>
            <button id="resetBtn" class="danger">Reiniciar</button>
          </div>

          <div id="tipBox" class="metric" style="margin-top:6px">
            <div class="label">Curiosidades sobre las cobras</div>
            <div id="tipText" class="val" style="font-size:14px;line-height:1.2">‚Äî</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer-page">
    Theo Anakin Fuentes - 1¬∞D - 2025
  </footer>

  <script>
    // === Tips fijos ===
    let tips = [
      "Las cobras despliegan su capucha para parecer m√°s grandes.",
      "La cobra real es el ofidio venenoso m√°s largo (hasta ~5.5 m).",
      "Algunas cobras escupen veneno para defenderse, apuntando a los ojos.",
      "Prefieren evitar conflictos: el alarde es advertencia, no ataque.",
      "Sus colmillos canalizan veneno; no todas las mordidas son iguales.",
      "La capucha se forma por costillas cervicales m√≥viles.",
      "El veneno afecta sistema nervioso (neurot√≥xico) en varias especies.",
      "La cobra real se alimenta de otras serpientes (¬°ofi√≥faga!).",
      "El color var√≠a entre especies: verdes, pardas, negras con anillos.",
      "Pueden vibrar la cola para disuadir depredadores.",
      "En mitolog√≠a asi√°tica simboliza poder y protecci√≥n.",
      "Su visi√≥n y olfato (a trav√©s de la lengua) gu√≠an la caza.",
      "Los ant√≠dotos son espec√≠ficos por tipo de veneno.",
      "Felicidades, llegaste al final del juego."
    ];

    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const GRID = 28;
    const SIZE = canvas.width;
    const CELL = Math.floor(SIZE / GRID);

    let msPerStep = 220; // base
    const withWalls = false; // por defecto PAREDES NO S√ìLIDAS
    const goalFruits = 140;

    let snake, dir, nextDir, food, growth, score, best, tickHandle, lastStepAt, running, paused;
    let fruitsCollected = 0;

    // elementos de progreso
    const fruitCountSpan = document.getElementById('fruitCount');
    const fruitGoalSpan  = document.getElementById('fruitGoal');
    const fruitFill      = document.getElementById('fruitFill');

    fruitGoalSpan.textContent = String(goalFruits);

    function updateFruitProgress(){
      fruitCountSpan.textContent = String(fruitsCollected);
      const ratio = Math.max(0, Math.min(1, fruitsCollected / goalFruits));
      fruitFill.style.width = (ratio * 100).toFixed(1) + "%";
    }

    function init(){
      const mid = Math.floor(GRID/2);
      snake = [ {x: mid, y: mid}, {x: mid-1, y: mid}, {x: mid-2, y: mid} ];
      dir = {x: 1, y: 0};
      nextDir = {x: 1, y: 0};
      growth = 0;
      score = 0; fruitsCollected = 0;
      msPerStep = 220; // reset velocidad
      best = Number(localStorage.getItem('cobra-best') || 0);
      document.getElementById('best').textContent = String(best);
      document.getElementById('score').textContent = '0';
      document.getElementById('tipText').textContent = '‚Äî';
      placeFood();
      running = false; paused = false; lastStepAt = 0;
      updateFruitProgress();
      draw();
    }

    function start(){ if(running) return; running = true; paused = false; lastStepAt = 0; loop(0); }
    function pause(){ paused = !paused; if(!paused) requestAnimationFrame(loop); }
    function reset(){ cancelAnimationFrame(tickHandle); init(); running = false; paused = false; }

    function placeFood(){
      let p;
      do { p = {x: randInt(0, GRID-1), y: randInt(0, GRID-1)}; }
      while (snake.some(s => s.x === p.x && s.y === p.y));
      food = p;
    }

    function loop(ts){
      tickHandle = requestAnimationFrame(loop);
      if(paused) return;
      if(!lastStepAt) lastStepAt = ts;
      const elapsed = ts - lastStepAt;
      if(elapsed >= msPerStep){
        step();
        lastStepAt = ts;
      }
      draw();
    }

    function step(){
      if ((nextDir.x !== -dir.x) || (nextDir.y !== -dir.y)) dir = nextDir;
      let head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};

      if(withWalls){
        if(head.x < 0 || head.y < 0 || head.x >= GRID || head.y >= GRID) return gameOver();
      } else {
        head.x = (head.x + GRID) % GRID;
        head.y = (head.y + GRID) % GRID;
      }

      if (snake.some((s, i) => i > 0 && s.x === head.x && s.y === head.y)) return gameOver();

      snake.unshift(head);

      if (head.x === food.x && head.y === food.y){
        score += 10; fruitsCollected += 1;
        document.getElementById('score').textContent = String(score);
        growth += 2;
        placeFood();
        updateFruitProgress();

        // Tip cada 10 frutas
        if (fruitsCollected % 10 === 0){
          const tipIndex = (fruitsCollected / 10 - 1) % tips.length;
          showTip(tipIndex);
        }

        // Aumento de velocidad cada 3 niveles (30 frutas)
        if (fruitsCollected % 30 === 0){
          msPerStep = Math.max(120, msPerStep - 20);
        }

        if (fruitsCollected >= goalFruits){
          return winGame();
        }
      }

      if(growth > 0){ growth--; } else { snake.pop(); }
    }

    function drawGrid(){
      ctx.save();
      ctx.strokeStyle = '#0e1724';
      ctx.lineWidth = 1;
      for(let i = 0; i <= GRID; i++){
        const p = Math.round(i * CELL) + 0.5;
        ctx.beginPath(); ctx.moveTo(p,0); ctx.lineTo(p,SIZE); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0,p); ctx.lineTo(SIZE,p); ctx.stroke();
      }
      ctx.restore();
    }

    function drawFood(){
      const {x,y} = food;
      const px = x * CELL, py = y * CELL;
      const r = Math.floor(CELL * 0.36);
      const gx = px + CELL/2, gy = py + CELL/2;
      const g = ctx.createRadialGradient(gx-2, gy-2, r*0.2, gx, gy, r);
      g.addColorStop(0, '#ffd6a6');
      g.addColorStop(1, '#ff7a18');
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(gx, gy, r, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = '#34d399'; ctx.lineWidth = 3; ctx.beginPath();
      ctx.moveTo(gx, gy-r + 3); ctx.quadraticCurveTo(gx+4, gy-r-6, gx+1, gy-r-10); ctx.stroke();
    }

    function drawCobraHead(x,y,angle){
      const px = x * CELL, py = y * CELL;
      const cx = px + CELL/2, cy = y * CELL + CELL/2;
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle);
      const s = CELL * 0.9;
      ctx.fillStyle = '#1ad16d';
      ctx.beginPath();
      ctx.moveTo(-s*0.45, -s*0.15);
      ctx.quadraticCurveTo(-s*0.55, 0, -s*0.45,  s*0.35);
      ctx.lineTo( s*0.45,  s*0.35);
      ctx.quadraticCurveTo( s*0.55, 0,  s*0.45, -s*0.15);
      ctx.closePath();
      ctx.fill();
      ctx.fillStyle = '#12b15b';
      ctx.beginPath();
      ctx.ellipse(0, 0, s*0.28, s*0.32, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = '#0a0f17';
      ctx.beginPath(); ctx.ellipse(-s*0.10, -s*0.05, s*0.05, s*0.08, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse( s*0.10, -s*0.05, s*0.05, s*0.08, 0, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = '#f43f5e'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(0, s*0.25); ctx.lineTo(0, s*0.42); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(0, s*0.42); ctx.lineTo(-s*0.06, s*0.5);
      ctx.moveTo(0, s*0.42); ctx.lineTo(s*0.06, s*0.5); ctx.stroke();
      ctx.restore();
    }

    function drawBody(x,y){
      const px = x * CELL, py = y * CELL;
      const g = ctx.createLinearGradient(px, py, px+CELL, py+CELL);
      g.addColorStop(0, '#0e8f49');
      g.addColorStop(1, '#22c55e');
      ctx.fillStyle = g;
      ctx.fillRect(px+1, py+1, CELL-2, CELL-2);
      ctx.globalAlpha = 0.12;
      ctx.fillStyle = '#000';
      for(let i = 0; i < 3; i++){
        ctx.beginPath();
        const r = CELL * 0.16, cx = px + CELL * (0.25 + i * 0.25), cy = py + CELL * 0.35;
        ctx.arc(cx, cy, r, Math.PI, 0);
        ctx.fill();
      }
      ctx.globalAlpha = 1;
    }

    function angleFromDir(d){
      if(d.x === 1 && d.y === 0) return 0;
      if(d.x === -1 && d.y === 0) return Math.PI;
      if(d.x === 0 && d.y === 1) return Math.PI/2;
      if(d.x === 0 && d.y === -1) return -Math.PI/2;
      return 0;
    }

    function draw(){
      ctx.clearRect(0,0,SIZE,SIZE);
      drawGrid();
      drawFood();
      for(let i = 1; i < snake.length; i++){
        drawBody(snake[i].x, snake[i].y);
      }
      const head = snake[0];
      drawCobraHead(head.x, head.y, angleFromDir(dir));
    }

    // === Overlay & tips ===
    const tipText = document.getElementById('tipText');
    const overlayEl = document.getElementById('overlay');
    const ovTitle = document.getElementById('ov-title');
    const ovText = document.getElementById('ov-text');
    const ovPrimary = document.getElementById('ov-primary');
    const ovSecondary = document.getElementById('ov-secondary');
    let overlayActive = false;

    function showTip(i){
      const txt = tips[i % tips.length] || '‚Äî';
      tipText.textContent = txt;
      showOverlay({
        title: 'Nivel superado',
        text: txt,
        primaryLabel: 'Continuar',
        primaryAction: () => {}
      });
    }

    function showOverlay({title, text, primaryLabel, primaryAction, secondaryLabel, secondaryAction}){
      ovTitle.textContent = title || '';
      ovText.textContent = text || '';
      ovPrimary.textContent = primaryLabel || 'OK';
      ovPrimary.onclick = () => { hideOverlay(); if(primaryAction) primaryAction(); };
      if(secondaryLabel){
        ovSecondary.classList.remove('hidden');
        ovSecondary.textContent = secondaryLabel;
        ovSecondary.onclick = () => { hideOverlay(); if(secondaryAction) secondaryAction(); };
      } else {
        ovSecondary.classList.add('hidden');
        ovSecondary.onclick = null;
      }
      overlayEl.classList.remove('hidden');
      overlayActive = true;
      paused = true;
    }

    function hideOverlay(){
      overlayEl.classList.add('hidden');
      overlayActive = false;
      paused = false;
    }

    function gameOver(){
      running = false; paused = true;
      best = Math.max(best, score);
      localStorage.setItem('cobra-best', String(best));
      document.getElementById('best').textContent = String(best);
      cancelAnimationFrame(tickHandle);
      showOverlay({
        title: '¬°Game Over! Cobra choc√≥',
        text: 'Puntaje: ' + score + ' ‚Ä¢ Frutas: ' + fruitsCollected,
        primaryLabel: 'Reiniciar',
        primaryAction: () => { reset(); start(); }
      });
    }

    function winGame(){
      running = false; paused = true;
      best = Math.max(best, score);
      localStorage.setItem('cobra-best', String(best));
      document.getElementById('best').textContent = String(best);
      cancelAnimationFrame(tickHandle);
      showOverlay({
        title: '¬°Ganaste! La Cobra conquist√≥ el tablero',
        text: 'Frutas: ' + fruitsCollected + ' ‚Ä¢ Puntaje: ' + score,
        primaryLabel: 'Reiniciar',
        primaryAction: () => { reset(); start(); }
      });
    }

    window.addEventListener('keydown', (e)=>{
      if(!overlayActive){
        const k = e.key.toLowerCase();
        if(['arrowup','w'].includes(k)) setNextDir(0,-1);
        else if(['arrowdown','s'].includes(k)) setNextDir(0,1);
        else if(['arrowleft','a'].includes(k)) setNextDir(-1,0);
        else if(['arrowright','d'].includes(k)) setNextDir(1,0);
        else if(k === ' '){ e.preventDefault(); pause(); }
      } else {
        const k = e.key.toLowerCase();
        if(k === 'enter' || k === ' '){ e.preventDefault(); ovPrimary.click(); }
        if(k === 'escape' && !ovSecondary.classList.contains('hidden')){ e.preventDefault(); ovSecondary.click(); }
      }
    });

    function setNextDir(nx,ny){ nextDir = {x:nx, y:ny}; }

    document.querySelectorAll('.dpad [data-dir]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const d = btn.getAttribute('data-dir');
        if(d === 'up') setNextDir(0,-1);
        if(d === 'down') setNextDir(0,1);
        if(d === 'left') setNextDir(-1,0);
        if(d === 'right') setNextDir(1,0);
      });
    });

    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');

    startBtn.addEventListener('click', ()=>{ if(!running){ start(); }});
    pauseBtn.addEventListener('click', ()=> pause());
    resetBtn.addEventListener('click', ()=> reset());

    // Self-tests simples
    function runSelfTests(){
      try{
        console.assert(typeof draw === 'function', 'draw() existe');
        console.assert(typeof step === 'function', 'step() existe');
        console.assert(canvas instanceof HTMLCanvasElement, 'canvas ok');
        placeFood();
        const ok = food && food.x >= 0 && food.x < GRID && food.y >= 0 && food.y < GRID;
        console.assert(ok, 'placeFood() ubic√≥ fruta dentro de la grilla');
        console.assert(document.getElementById('overlay'), 'overlay existe');
        console.assert(typeof showOverlay === 'function', 'showOverlay() existe');
        console.assert(typeof updateFruitProgress === 'function', 'updateFruitProgress() existe');
        console.log('[CobraSnake] self-tests OK');
      }catch(e){ console.warn('[CobraSnake] self-tests fallo', e); }
    }

    init();
    runSelfTests();
  </script>
</body>
</html>
